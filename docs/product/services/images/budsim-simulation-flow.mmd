%%{init: {'theme': 'default', 'themeVariables': {'background': '#ffffff'}}}%%
sequenceDiagram
    participant budapp
    participant budsim
    participant Dapr as Dapr Workflow
    participant PostgreSQL
    participant budcluster

    budapp->>budsim: POST /simulator/run {model, tokens, targets}
    budsim->>Dapr: Start simulation workflow
    Dapr-->>budsim: {workflow_id, steps}
    budsim-->>budapp: {workflow_id, eta}

    Note over budsim,budcluster: Workflow Execution
    budsim->>budcluster: Get available clusters
    budcluster-->>budsim: {clusters, nodes, devices}
    budsim->>budsim: Analyze cluster topology
    budsim->>budsim: Group devices by type
    budsim->>budsim: Get compatible engines

    loop For each cluster/device/engine
        budsim->>budsim: Run Evolution (GA) or Heuristic
        budsim->>PostgreSQL: Store simulation results
    end

    budsim->>budsim: Aggregate recommendations
    budsim->>budapp: Notify simulation complete
    budapp->>budsim: GET /recommendations?workflow_id
    budsim->>PostgreSQL: Fetch top-k configs
    budsim-->>budapp: {recommendations}
