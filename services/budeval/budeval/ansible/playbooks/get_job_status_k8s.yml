---
- name: Get Kubernetes Job Status
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - kubernetes.core

  tasks:
    - name: Get job information
      kubernetes.core.k8s_info:
        api_version: batch/v1
        kind: Job
        name: "{{ job_name }}"
        namespace: "{{ namespace }}"
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      register: job_info

    - name: Get pod information for the job
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - "job-name={{ job_name }}"
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      register: pod_info

    - name: Set job status facts
      set_fact:
        job_status:
          job_name: "{{ job_name }}"
          phase: "{{ (job_info.resources[0].status.conditions[-1].type if (job_info.resources and job_info.resources[0].status is defined and job_info.resources[0].status.conditions is defined and (job_info.resources[0].status.conditions|length > 0)) else 'NotFound') }}"
          active: "{{ job_info.resources[0].status.active | default(0) | int }}"
          succeeded: "{{ job_info.resources[0].status.succeeded | default(0) | int }}"
          failed: "{{ job_info.resources[0].status.failed | default(0) | int }}"
          pod_count: "{{ pod_info.resources | length | int }}"
