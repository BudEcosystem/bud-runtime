---
- name: Get Kubernetes Job Status
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
      - community.kubernetes

  tasks:
      - name: Get job information
        community.kubernetes.k8s_info:
            api_version: batch/v1
            kind: Job
            name: "{{ job_name }}"
            namespace: "{{ namespace }}"
            kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        register: job_info

      - name: Get pod information for the job
        community.kubernetes.k8s_info:
            api_version: v1
            kind: Pod
            namespace: "{{ namespace }}"
            label_selectors:
                - "job-name={{ job_name }}"
            kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        register: pod_info

      - name: Get data PVC status
        community.kubernetes.k8s_info:
            api_version: v1
            kind: PersistentVolumeClaim
            name: "{{ job_name }}-data-pvc"
            namespace: "{{ namespace }}"
            kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        register: data_pvc_info

      - name: Get output PVC status
        community.kubernetes.k8s_info:
            api_version: v1
            kind: PersistentVolumeClaim
            name: "{{ job_name }}-output-pvc"
            namespace: "{{ namespace }}"
            kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        register: output_pvc_info

      - name: Display job status
        debug:
            msg: |
                Job Status for {{ job_name }}:
                Job Phase: {{ (job_info.resources[0].status.conditions[-1].type if (job_info.resources and job_info.resources[0].status is defined and job_info.resources[0].status.conditions is defined and (job_info.resources[0].status.conditions|length > 0)) else 'Not Found') }}
                Job Active: {{ job_info.resources[0].status.active | default(0) }}
                Job Succeeded: {{ job_info.resources[0].status.succeeded | default(0) }}
                Job Failed: {{ job_info.resources[0].status.failed | default(0) }}
                Pod Count: {{ pod_info.resources | length }}
                Data PVC Status: {{ data_pvc_info.resources[0].status.phase if data_pvc_info.resources else 'Not Found' }}
                Output PVC Status: {{ output_pvc_info.resources[0].status.phase if output_pvc_info.resources else 'Not Found' }}

      - name: Set job status facts
        set_fact:
            job_status:
                job_name: "{{ job_name }}"
                phase: "{{ (job_info.resources[0].status.conditions[-1].type if (job_info.resources and job_info.resources[0].status is defined and job_info.resources[0].status.conditions is defined and (job_info.resources[0].status.conditions|length > 0)) else 'NotFound') }}"
                active: "{{ job_info.resources[0].status.active | default(0) | int }}"
                succeeded: "{{ job_info.resources[0].status.succeeded | default(0) | int }}"
                failed: "{{ job_info.resources[0].status.failed | default(0) | int }}"
                pod_count: "{{ pod_info.resources | length | int }}"
                data_pvc_status: "{{ data_pvc_info.resources[0].status.phase if data_pvc_info.resources else 'NotFound' }}"
                output_pvc_status: "{{ output_pvc_info.resources[0].status.phase if output_pvc_info.resources else 'NotFound' }}"
