---
- name: Extract Evaluation Results from PVC
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - kubernetes.core

  vars:
    extractor_image: "busybox:1.35"
    wait_timeout: 180

  tasks:
    - name: Ensure local extraction directory exists
      file:
        path: "{{ local_extract_path }}"
        state: directory
        mode: '0755'

    - name: Create extraction pod
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        definition:
          apiVersion: v1
          kind: Pod
          metadata:
            name: "{{ job_id }}-extract"
            namespace: "{{ namespace }}"
            labels:
              app: eval-result-extractor
              job-id: "{{ job_id }}"
          spec:
            restartPolicy: Never
            containers:
            - name: extractor
              image: "{{ extractor_image }}"
              command: ["sleep", "{{ wait_timeout | string }}"]
              volumeMounts:
              - name: output
                mountPath: /workspace/outputs
                subPath: "{{ results_subpath }}"
                readOnly: true
            volumes:
            - name: output
              persistentVolumeClaim:
                claimName: "{{ pvc_name }}"

    - name: Wait for extraction pod to be ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        name: "{{ job_id }}-extract"
        namespace: "{{ namespace }}"
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"
      register: pod_info
      until: >
        pod_info.resources | length > 0 and
        pod_info.resources[0].status is defined and
        pod_info.resources[0].status.phase == "Running"
      retries: 20
      delay: 3

    - name: Create job-specific extraction directory
      file:
        path: "{{ local_extract_path }}/{{ job_id }}"
        state: directory
        mode: '0755'

    - name: Copy results from pod to local filesystem
      shell: |
        kubectl cp {{ namespace }}/{{ job_id }}-extract:/workspace/outputs \
        "{{ local_extract_path }}/{{ job_id }}/outputs" \
        {% if kubeconfig_path is defined %}--kubeconfig {{ kubeconfig_path }}{% endif %}
      register: copy_result
      failed_when: copy_result.rc != 0

    - name: Delete extraction pod
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        name: "{{ job_id }}-extract"
        namespace: "{{ namespace }}"
        kubeconfig: "{{ kubeconfig_path | default(omit) }}"

    - name: Set extraction results facts
      set_fact:
        extraction_result:
          job_id: "{{ job_id }}"
          status: "success"
          local_path: "{{ local_extract_path }}/{{ job_id }}/outputs"
