---
- name: Get Kubernetes Job Status (Simple)
  hosts: localhost
  connection: local
  gather_facts: no
  collections:
      - community.kubernetes

  tasks:
      - name: Get job information
        community.kubernetes.k8s_info:
            api_version: batch/v1
            kind: Job
            name: "{{ job_name }}"
            namespace: "{{ namespace }}"
            kubeconfig: "{{ kubeconfig_path | default(omit) }}"
        register: job_info
        ignore_errors: yes

      - name: Set job exists flag
        set_fact:
            job_exists: "{{ job_info.resources | length > 0 }}"

      - name: Build simple job status
        set_fact:
            job_status:
                job_id: "{{ job_name }}"
                namespace: "{{ namespace }}"
                exists: "{{ job_exists }}"
                status: >-
                    {%- if not job_exists -%}not_found
                    {%- elif (job_info.resources[0].status.succeeded | default(0) | int) > 0 -%}succeeded
                    {%- elif (job_info.resources[0].status.failed | default(0) | int) > 0 -%}failed
                    {%- elif (job_info.resources[0].status.active | default(0) | int) > 0 -%}running
                    {%- else -%}pending{%- endif -%}
                active: "{{ job_info.resources[0].status.active | default(0) | int if job_exists else 0 }}"
                succeeded: "{{ job_info.resources[0].status.succeeded | default(0) | int if job_exists else 0 }}"
                failed: "{{ job_info.resources[0].status.failed | default(0) | int if job_exists else 0 }}"
                start_time: "{{ job_info.resources[0].status.startTime | default('') if job_exists else '' }}"
                completion_time: "{{ job_info.resources[0].status.completionTime | default('') if job_exists else '' }}"

      - name: Output result as JSON
        debug:
            msg: "{{ {'success': true, 'job_status': job_status} | to_json }}"

      - name: Write JSON to file if requested
        copy:
            content: "{{ {'success': true, 'job_status': job_status} | to_nice_json }}"
            dest: "{{ output_file }}"
        when: output_file is defined
