---
- name: Parse Job Logs for ETA and Progress
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_path: ""
    namespace: "default"
    job_names: ""  # Comma-separated job names
    temp_id: ""

  tasks:
    - name: Ensure required variables are provided
      ansible.builtin.assert:
        that:
          - namespace is defined
          - namespace | length > 0
          - job_names is defined
          - job_names | length > 0
          - temp_id is defined
          - temp_id | length > 0
        fail_msg: "namespace, job_names, and temp_id must be provided"

    - name: Split job names into list
      ansible.builtin.set_fact:
        job_list: "{{ job_names.split(',') }}"

    - name: Initialize results dictionary
      ansible.builtin.set_fact:
        log_progress: {}

    - name: Get pods for each job
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - "job-name={{ item }}"
        kubeconfig: "{{ kubeconfig_path if kubeconfig_path else omit }}"
      register: job_pods
      loop: "{{ job_list }}"
      ignore_errors: true

    - name: Get logs from each pod
      kubernetes.core.k8s_log:
        api_version: v1
        kind: Pod
        name: "{{ item.resources[0].metadata.name }}"
        namespace: "{{ namespace }}"
        tail_lines: 500  # Last 500 lines for efficiency
        kubeconfig: "{{ kubeconfig_path if kubeconfig_path else omit }}"
      register: pod_logs
      loop: "{{ job_pods.results }}"
      when: item.resources | length > 0
      ignore_errors: true

    - name: Parse logs for ETA and progress data
      ansible.builtin.shell: |
        python3 << 'EOF'
        import re
        import json
        import sys

        def parse_opencompass_logs(log_text):
            """Extract ETA_DATA and PROGRESS_DATA from OpenCompass logs."""

            result = {
                "eta_data": None,
                "latest_progress": None,
                "progress_percentage": 0,
                "status": "no_logs"
            }

            if not log_text:
                return result

            # Find all ETA_DATA entries (usually just one)
            eta_pattern = r'ETA_DATA:\s*(\{[^}]+\})'
            eta_matches = re.findall(eta_pattern, log_text)
            if eta_matches:
                try:
                    result["eta_data"] = json.loads(eta_matches[-1])  # Latest
                except json.JSONDecodeError:
                    pass

            # Find all PROGRESS_DATA entries
            progress_pattern = r'PROGRESS_DATA:\s*(\{[^}]+\})'
            progress_matches = re.findall(progress_pattern, log_text)
            if progress_matches:
                try:
                    result["latest_progress"] = json.loads(progress_matches[-1])  # Latest

                    # Calculate progress percentage
                    progress = result["latest_progress"]
                    batches_completed = progress.get("batches_completed", 0)
                    batches_total = progress.get("batches_total", 1)
                    result["progress_percentage"] = (batches_completed / batches_total) * 100
                    result["status"] = "running"

                except json.JSONDecodeError:
                    pass

            # If we have ETA but no progress yet, job is starting
            if result["eta_data"] and not result["latest_progress"]:
                result["status"] = "starting"
                result["progress_percentage"] = 0

            return result

        # Read log text from stdin
        log_text = sys.stdin.read()
        result = parse_opencompass_logs(log_text)
        print(json.dumps(result))
        EOF
      args:
        stdin: "{{ item.log | default('') }}"
      register: parsed_logs
      loop: "{{ pod_logs.results }}"
      when: item.log is defined
      ignore_errors: true

    - name: Build log progress map
      ansible.builtin.set_fact:
        log_progress: >-
          {{
            log_progress | combine({
              item.item.item.item: parsed_result
            })
          }}
      vars:
        parsed_result: "{{ item.stdout | from_json }}"
      loop: "{{ parsed_logs.results }}"
      when:
        - item.stdout is defined
        - item.stdout | length > 0
      ignore_errors: true

    - name: Write results to temporary file
      ansible.builtin.copy:
        content: "{{ log_progress | to_nice_json }}"
        dest: "/tmp/log_progress_{{ temp_id }}.json"
