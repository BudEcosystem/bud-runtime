version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: budpipeline
      POSTGRES_PASSWORD: budpipeline_dev
      POSTGRES_DB: budpipeline
    volumes:
      - budpipeline-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U budpipeline -d budpipeline"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  budpipeline:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SERVICE_NAME=budpipeline
      - SERVICE_PORT=8000
      - LOG_LEVEL=DEBUG
      - DEBUG=true
      - DAPR_HTTP_ENDPOINT=http://localhost:3500
      - DATABASE_URL=postgresql+asyncpg://budpipeline:budpipeline_dev@postgres:5432/budpipeline
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  budpipeline-dapr:
    image: "daprio/daprd:1.12.0"
    command:
      [
        "./daprd",
        "--app-id", "budpipeline",
        "--app-port", "8000",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/components",
        "--log-level", "debug",
      ]
    volumes:
      - "./dapr/components:/components"
    network_mode: "service:budpipeline"
    depends_on:
      - budpipeline
      - redis

volumes:
  budpipeline-postgres-data:
