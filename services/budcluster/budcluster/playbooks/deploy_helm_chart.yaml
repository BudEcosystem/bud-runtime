---
- name: Deploy Generic Helm Chart
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars/common.yaml

  vars:
    release_name: "{{ helm_release_name }}"
    chart_ref: "{{ helm_chart_ref | default('') }}"
    chart_version: "{{ helm_chart_version | default(omit) }}"
    target_namespace: "{{ namespace }}"
    helm_values: "{{ values | default({}) }}"
    wait_for_ready: "{{ helm_wait | default(true) }}"
    wait_timeout: "{{ helm_timeout | default('600s') }}"
    create_ns: "{{ create_namespace | default(true) }}"
    git_repo: "{{ helm_git_repo | default('') }}"
    git_ref: "{{ helm_git_ref | default('main') }}"
    chart_subpath: "{{ helm_chart_subpath | default('.') }}"

  roles:
    - create_kubeconfig

  tasks:
    - name: Create namespace if it does not exist
      kubernetes.core.k8s:
        kind: Namespace
        name: "{{ target_namespace }}"
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
      when: create_ns | bool

    - name: Create temporary directory for git clone
      ansible.builtin.tempfile:
        state: directory
        prefix: helm_git_
      register: git_tmpdir
      when: git_repo | length > 0

    - name: Clone chart repository
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "{{ git_tmpdir.path }}"
        version: "{{ git_ref }}"
        depth: 1
        single_branch: true
      when: git_repo | length > 0

    - name: Set chart_ref to cloned path
      ansible.builtin.set_fact:
        chart_ref: "{{ git_tmpdir.path }}/{{ chart_subpath }}"
      when: git_repo | length > 0

    - name: Deploy Helm chart
      kubernetes.core.helm:
        release_name: "{{ release_name }}"
        chart_ref: "{{ chart_ref }}"
        chart_version: "{{ chart_version }}"
        release_namespace: "{{ target_namespace }}"
        create_namespace: "{{ create_ns | bool }}"
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
        wait: "{{ wait_for_ready | bool }}"
        timeout: "{{ wait_timeout }}"
        values: "{{ helm_values }}"
      register: helm_result
      failed_when: helm_result.failed

    - name: Gather deployed Service resources
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ target_namespace }}"
        label_selectors:
          - "app.kubernetes.io/instance={{ release_name }}"
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
      register: deployed_services
      when: not helm_result.failed

    - name: Clean up git clone directory
      ansible.builtin.file:
        path: "{{ git_tmpdir.path }}"
        state: absent
      when: git_repo | length > 0 and git_tmpdir.path is defined
