---
- name: Create HTTPRoute for Use Case Access
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars/common.yaml

  vars:
    deployment_id: "{{ usecase_deployment_id }}"
    target_namespace: "{{ namespace }}"
    service_name: "{{ helm_service_name }}"
    gateway_name: "{{ envoy_gateway_name | default('aibrix-eg') }}"
    gateway_namespace: "{{ envoy_gateway_namespace | default('aibrix-system') }}"
    ui_enabled: "{{ access_ui_enabled | default(false) }}"
    ui_port: "{{ access_ui_port | default(80) }}"
    ui_path: "{{ access_ui_path | default('/') }}"
    api_enabled: "{{ access_api_enabled | default(false) }}"
    api_port: "{{ access_api_port | default(8080) }}"
    api_base_path: "{{ access_api_base_path | default('/') }}"
    ui_service_suffix: "{{ access_ui_service_suffix | default('') }}"
    api_service_suffix: "{{ access_api_service_suffix | default('') }}"

  roles:
    - create_kubeconfig

  tasks:
    - name: Create ReferenceGrant for cross-namespace routing
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
        definition:
          apiVersion: gateway.networking.k8s.io/v1beta1
          kind: ReferenceGrant
          metadata:
            name: "allow-aibrix-gateway"
            namespace: "{{ target_namespace }}"
          spec:
            from:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                namespace: "{{ gateway_namespace }}"
            to:
              - group: ""
                kind: Service
      when: ui_enabled | bool or api_enabled | bool

    - name: Build HTTPRoute rules
      ansible.builtin.set_fact:
        httproute_rules: >-
          {{
            (ui_enabled | bool) | ternary(
              [{"matches": [{"path": {"type": "PathPrefix", "value": "/usecases/" + deployment_id + "/ui"}}],
                "filters": [
                  {"type": "URLRewrite", "urlRewrite": {"path": {"type": "ReplacePrefixMatch", "replacePrefixMatch": ui_path}}},
                  {"type": "ResponseHeaderModifier", "responseHeaderModifier": {
                    "remove": ["Access-Control-Expose-Headers", "Access-Control-Allow-Origin", "Access-Control-Allow-Methods", "Access-Control-Allow-Headers", "Access-Control-Allow-Credentials"],
                    "add": [
                      {"name": "Access-Control-Expose-Headers", "value": "Authorization, Content-Type"},
                      {"name": "Access-Control-Allow-Origin", "value": "*"},
                      {"name": "Access-Control-Allow-Methods", "value": "GET, POST, PUT, DELETE, OPTIONS"},
                      {"name": "Access-Control-Allow-Headers", "value": "Authorization, Content-Type, Accept"}
                    ]
                  }}
                ],
                "backendRefs": [{"name": service_name + ui_service_suffix, "namespace": target_namespace, "port": ui_port | int}]}],
              []
            )
            +
            (api_enabled | bool) | ternary(
              [{"matches": [{"path": {"type": "PathPrefix", "value": "/usecases/" + deployment_id + "/api"}}],
                "filters": [
                  {"type": "URLRewrite", "urlRewrite": {"path": {"type": "ReplacePrefixMatch", "replacePrefixMatch": api_base_path}}},
                  {"type": "ResponseHeaderModifier", "responseHeaderModifier": {
                    "remove": ["Access-Control-Expose-Headers", "Access-Control-Allow-Origin", "Access-Control-Allow-Methods", "Access-Control-Allow-Headers", "Access-Control-Allow-Credentials"],
                    "add": [
                      {"name": "Access-Control-Expose-Headers", "value": "Authorization, Content-Type"},
                      {"name": "Access-Control-Allow-Origin", "value": "*"},
                      {"name": "Access-Control-Allow-Methods", "value": "GET, POST, PUT, DELETE, OPTIONS"},
                      {"name": "Access-Control-Allow-Headers", "value": "Authorization, Content-Type, Accept"}
                    ]
                  }}
                ],
                "backendRefs": [{"name": service_name + api_service_suffix, "namespace": target_namespace, "port": api_port | int}]}],
              []
            )
          }}

    - name: Create HTTPRoute
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
        definition:
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          metadata:
            name: "usecase-{{ deployment_id }}"
            namespace: "{{ gateway_namespace }}"
          spec:
            parentRefs:
              - name: "{{ gateway_name }}"
                namespace: "{{ gateway_namespace }}"
            rules: "{{ httproute_rules }}"
      when: httproute_rules | length > 0

    - name: Discover Envoy Gateway external endpoint
      kubernetes.core.k8s_info:
        kind: Service
        name: "{{ gateway_name }}"
        namespace: "{{ gateway_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: "{{ validate_certs }}"
      register: eg_service

    - name: Extract gateway endpoint
      ansible.builtin.set_fact:
        gateway_endpoint: >-
          {{
            eg_service.resources[0].status.loadBalancer.ingress[0].hostname
            | default(eg_service.resources[0].status.loadBalancer.ingress[0].ip, true)
          }}
      when: eg_service.resources | length > 0
