# NFD Worker Configuration with enhanced CPU detection
# This configuration enables detection of CPU model names through local hooks

apiVersion: v1
kind: ConfigMap
metadata:
  name: nfd-worker-conf
  namespace: node-feature-discovery
data:
  nfd-worker.conf: |
    core:
      labelSources:
        - custom
        - pci
        - cpu
        - kernel
        - local
        - memory
        - network
        - storage
        - system
        - usb

      sleepInterval: 60s

      # Allow feature labels and extended resources
      labelWhiteList: "feature.node.kubernetes.io/.*"

    sources:
      # CPU source configuration
      cpu:
        cpuid:
          # Include all CPU features for comprehensive detection
          attributeBlacklist: []
          attributeWhitelist:
            - "AVX"
            - "AVX2"
            - "AVX512BF16"
            - "AVX512BW"
            - "AVX512CD"
            - "AVX512DQ"
            - "AVX512F"
            - "AVX512VL"
            - "AVX512VNNI"
            - "FMA3"
            - "SSE4.1"
            - "SSE4.2"
            - "VNNI"
            - "AMX"

      # System source for basic info
      system:
        osRelease:
          id:
            - "ID"
            - "VERSION_ID"
        name:
          - "nodename"

      # Local source for CPU model detection via hooks
      local:
        hooksEnabled: true

      # Custom rules for CPU model extraction
      custom:
        - name: "cpu-model"
          labels:
            "local-cpu.model": "@cpu.model"
          matchOn:
            - cpuId:
                model: [".*"]

        - name: "cpu-vendor"
          labels:
            "local-cpu.vendor": "@cpu.vendor"
          matchOn:
            - cpuId:
                vendor: [".*"]

      # PCI device detection
      pci:
        deviceClassWhitelist:
          - "0300"  # VGA compatible controller
          - "0302"  # 3D controller
          - "0b40"  # Co-processor
        deviceLabelFields:
          - vendor
          - device
          - class
          - subsystem_vendor
          - subsystem_device
