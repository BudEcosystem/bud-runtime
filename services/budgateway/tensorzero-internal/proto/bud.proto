syntax = "proto3";

package bud;

service BudService {
  rpc CreateProfile(ProfileRequest) returns (ProfileResponse);
  rpc GetProfile(GetProfileRequest) returns (ProfileResponse);
  rpc ListProfiles(ListProfilesRequest) returns (ListProfilesResponse);
  rpc UpdateProfile(ProfileRequest) returns (ProfileResponse);
  rpc DeleteProfile(DeleteProfileRequest) returns (DeleteProfileResponse);
  rpc Moderate(ModerationRequest) returns (ModerationResponse);
  rpc Health(HealthRequest) returns (HealthResponse);
}

message Profile {
  string id = 1;
  string strategy_id = 2;
  string description = 3;
  string version = 4;
  repeated string enabled_rules = 5;
  repeated string enabled_probes = 6;
  optional float severity_threshold = 7;
  string metadata_json = 8;
  string rule_overrides_json = 9;
  repeated CustomRule custom_rules = 10;  // Profile-scoped inline rules
}

// Custom rule defined inline in a profile (profile-scoped)
message CustomRule {
  string id = 1;                           // Rule identifier
  string scanner = 2;                      // Scanner engine (e.g., "llm", "latentbud")
  string scanner_config_json = 3;          // Scanner config as JSON string
  repeated string target_labels = 4;       // Labels that trigger findings
  optional float severity_threshold = 5;   // Optional threshold override
  optional string probe = 6;               // Optional probe assignment
  optional string name = 7;                // Optional human-readable name
  optional string description = 8;         // Optional description
  optional string post_processing_json = 9; // Optional post-processing pipeline as JSON array
}

message ProfileRequest {
  Profile profile = 1;
}

message ProfileResponse {
  Profile profile = 1;
}

message GetProfileRequest {
  string id = 1;
}

message ListProfilesRequest {}

message ListProfilesResponse {
  repeated Profile profiles = 1;
}

message DeleteProfileRequest {
  string id = 1;
}

message DeleteProfileResponse {}

// OpenAI-compatible conversation message
message ConversationMessage {
  string role = 1;     // "system", "user", "assistant", "tool"
  string content = 2;
  optional string name = 3;  // for tool messages
}

message ModerationRequest {
  string profile_id = 1;
  repeated string inputs = 2;
  repeated ConversationMessage conversations = 3;  // OpenAI-compatible: [{role, content}, ...]
  optional float severity_threshold = 4;
}

message ModerationResponse {
  string model = 1;
  repeated ModerationResult results = 2;
}

message ModerationResult {
  bool flagged = 1;
  map<string, bool> categories = 2;
  map<string, double> category_scores = 3;
  repeated Finding findings = 4;
}

message Finding {
  string rule_id = 1;
  bool triggered = 2;
  oneof signal {
    ClassificationFinding classification = 3;
    PatternFinding pattern = 4;
  }
}

message ClassificationFinding {
  string label = 1;
  double confidence = 2;
  bool triggered = 3;
  optional int32 turn_index = 4;   // NEW: 0-based index into conversation
  optional string turn_role = 5;   // NEW: "user", "assistant", etc.
}

message PatternFinding {
  repeated PatternMatch matches = 1;
}

message PatternMatch {
  uint64 start = 1;
  uint64 end = 2;
  string value = 3;
  double score = 4;
  bool triggered = 5;
}

message HealthRequest {}

message HealthResponse {
  bool ready = 1;
  bool warmup_in_progress = 2;
  bool catalog_loaded = 3;
  uint64 profile_count = 4;
  string last_error = 5;
}
