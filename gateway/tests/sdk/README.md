# TensorZero OpenAI Integration Tests

This directory contains integration tests that validate TensorZero's OpenAI-compatible endpoints using the official OpenAI Python SDK.

## Setup

1. **Install Dependencies**
   ```bash
   cd gateway/tests/integration_tests
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **Configure Environment**
   ```bash
   cp .env.example .env
   # Edit .env and set your OpenAI API key
   ```

3. **Start TensorZero Gateway**
   ```bash
   # From the repository root
   cargo run --bin gateway -- --config-file gateway/tests/integration_tests/test_config.toml
   ```

## Running Tests

### Full Integration Tests (Requires OpenAI API Key)

To run all integration tests with real OpenAI API:
```bash
./run_tests_full.sh
```

To run tests with comparison against direct OpenAI API:
```bash
./run_tests_full.sh --compare
```

### CI Tests (Uses Dummy Provider)

To run CI-friendly tests without requiring API keys:
```bash
# Start gateway with CI config first:
cargo run --bin gateway --features e2e_tests -- --config-file gateway/tests/sdk/test_config_ci.toml

# Then run CI tests:
./run_tests_ci.sh
```

### Run Specific Test Module
```bash
# Full tests (requires API key)
pytest test_chat.py -v
pytest test_embeddings.py -v
pytest test_moderation.py -v
pytest test_audio.py -v
pytest test_images.py -v

# CI tests (dummy provider)
pytest test_ci_basic.py -v      # All endpoints
pytest test_ci_chat.py -v       # Chat specific
pytest test_ci_images.py -v     # Images specific
```

## Test Coverage

### Chat Completions (`test_chat.py`)
- Basic completions
- Streaming responses
- Function calling
- Multiple models
- Various parameters (temperature, max_tokens, etc.)
- Error handling
- Async operations

### Embeddings (`test_embeddings.py`)
- Single and batch embeddings
- Different models (ada-002, text-embedding-3-small)
- Custom dimensions
- Large batches
- Special characters
- Similarity testing
- Async operations

### Moderation (`test_moderation.py`)
- Content moderation
- Batch moderation
- Category scores
- Unicode and special characters
- Large batches
- Async operations

### Audio (`test_audio.py`)
- **Transcription**: Convert audio to text
- **Translation**: Convert non-English audio to English text
- **Text-to-Speech**: Generate audio from text
- Various voices and formats
- Response format options
- Async operations

### Images (`test_images.py`)
- **Generation**: Create images from text prompts (DALL-E 2, DALL-E 3, GPT-Image-1)
- **Editing**: Modify existing images with prompts and masks
- **Variations**: Generate variations of existing images
- Multiple image sizes and quality settings
- URL and base64 response formats
- Model-specific parameters (style, quality, background)
- Async operations
- Performance and stress testing

## Configuration

The `test_config.toml` file configures TensorZero with:
- All OpenAI model variants
- Authentication enabled (static API key: `test-api-key`)
- Debug mode for troubleshooting

## Troubleshooting

### Gateway Not Running
```
Error: TensorZero gateway is not running!
```
Solution: Start the gateway with the test configuration file.

### Missing API Key
```
Error: OPENAI_API_KEY is not set!
```
Solution: Set your OpenAI API key in the `.env` file.

### Audio Tests Failing
The audio tests require a sample MP3 file. The test runner automatically downloads a sample, but if this fails:
```bash
cd fixtures/audio_samples
# Download any small MP3 file and name it sample.mp3
```

### Image Tests Failing
The image tests require test images which are automatically generated by `create_test_images.py`. If this fails:
```bash
cd fixtures/images
# The script creates various test images including:
# - test_image.png (512x512 test image)
# - simple_shape.png (simple shape for variations)
# - mask.png (mask for editing tests)
```

## Adding New Tests

1. Create a new test file following the pattern `test_<endpoint>.py`
2. Import the configured clients:
   ```python
   from openai import OpenAI
   tensorzero_client = OpenAI(base_url=f"{TENSORZERO_BASE_URL}/v1", api_key=TENSORZERO_API_KEY)
   ```
3. Write test classes and methods
4. Update `run_tests.sh` if needed

## CI Integration

### For GitHub Actions (No API Keys Required)
```yaml
- name: Start TensorZero with CI Config
  run: cargo run --bin gateway --features e2e_tests -- --config-file gateway/tests/sdk/test_config_ci.toml &
  
- name: Run CI Integration Tests
  run: cd gateway/tests/sdk && ./run_tests_ci.sh
```

### For Full Testing (Requires API Keys)
```yaml
- name: Start TensorZero
  run: cargo run --bin gateway -- --config-file gateway/tests/sdk/test_config.toml &
  
- name: Run Full Integration Tests
  run: cd gateway/tests/sdk && ./run_tests_full.sh
```