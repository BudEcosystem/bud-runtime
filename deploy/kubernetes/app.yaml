apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: appconfig
  namespace: dapr-system
spec:
  type: secretstores.kubernetes
  version: v1
  metadata:
  - name: yaml
    value: |
      NAMESPACE: dapr-system
      LOG_LEVEL: DEBUG
      CONFIGSTORE_NAME: configstore
      SECRETSTORE_NAME: secretstore-local
      DAPR_API_METHOD_INVOCATION_PROTOCOL: grpc
      DAPR_API_TOKEN: aVsS8i6aUevzP8uIL2LO6Q==
      ENABLE_PROFILER: "false"
      DAPR_HTTP_PORT: "3510"
      DAPR_GRPC_PORT: "50001"
      NOVU_API_BASE_URL: "http://api.dapr-system:3000"
      PATH: "/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      LANG: "C.UTF-8"
      GPG_KEY: "A035C8C19219BA821ECEA86B64E628F8D684696D"
      PYTHON_VERSION: "3.11.0"
      PYTHON_PIP_VERSION: "22.3"
      PYTHON_SETUPTOOLS_VERSION: "65.5.0"
      PYTHON_GET_PIP_URL: "https://github.com/pypa/get-pip/raw/66030fa03382b4914d4c4d0896961a0bdeeeb274/public/get-pip.py"
      PYTHON_GET_PIP_SHA256: "1e501cf004eac1b7eb1f97266d28f995ae835d30250bec7f8850562703067dc6"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bud-mf-development-notify
  namespace: dapr-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notify
  template:
    metadata:
      labels:
        app: notify
      annotations:
        dapr.io/enabled: "true"
        dapr.io/app-id: "bud-mf-development-notify"
        dapr.io/app-port: "3000"
        dapr.io/config: "appconfig-notify"
        dapr.io/placement-host-address: "dapr-placement-server.dapr-system:50005"
    spec:
      containers:
      - name: notify
        image: docker.io/library/bud-serve-notify:latest
        command: ["uvicorn", "notify.main:app", "--host", "0.0.0.0", "--port", "3000"]
        ports:
        - containerPort: 3000
        env:
        - name: APP_CONFIG
          value: "{}"  # Dapr will inject the configuration values
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
          requests:
            memory: "256Mi"
            cpu: "250m"
        volumeMounts:
        - mountPath: /data                    # Path inside the container to mount the PVC
          name: notify-storage                 # Reference to the volume name defined below
      volumes:
      - name: notify-storage
        persistentVolumeClaim:
          claimName: bud-notify-1              # Name of the PVC created earlier

---
apiVersion: v1
kind: Service
metadata:
  name: app-service
  namespace: dapr-system
spec:
  ports:
  - port: 3000
    targetPort: 3000
  selector:
    app: notify
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bud-notify-1          # Name of the PVC
  namespace: dapr-system          # Namespace (adjust as needed)
spec:
  accessModes:
    - ReadWriteOnce           # Can also be ReadOnlyMany or ReadWriteMany, depending on your storage
  resources:
    requests:
      storage: 5Gi            # Requested storage size
  storageClassName: local-path  # Name of your StorageClass (adjust if needed)
  volumeMode: Filesystem
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: bud-notify-1
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-path
  hostPath:
    path: /datadisk/pvc/bud-notify-pv  # Adjust this path as needed

