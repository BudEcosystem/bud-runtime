{{- if .Values.onyx.enabled }}
# PostgreSQL credentials for Onyx (shared from bud's PostgreSQL)
# Uses the 'onyx' service user created by the postgres-db-create Job
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-onyx-postgresql
  labels:
    app.kubernetes.io/component: onyx
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
data:
  username: {{ .Values.externalServices.postgresql.databases.onyx.username | b64enc }}
  password: {{ .Values.externalServices.postgresql.databases.onyx.password | b64enc }}
---
# Redis/Valkey credentials for Onyx (shared from bud's Valkey)
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-onyx-redis
  labels:
    app.kubernetes.io/component: onyx
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
data:
  redis_password: {{ .Values.valkey.auth.password | b64enc }}
---
# MinIO/S3 credentials for Onyx (shared from bud's MinIO)
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-onyx-objectstorage
  labels:
    app.kubernetes.io/component: onyx
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
data:
  s3_aws_access_key_id: {{ .Values.minio.auth.rootUser | b64enc }}
  s3_aws_secret_access_key: {{ .Values.minio.auth.rootPassword | b64enc }}
  rootUser: {{ .Values.minio.auth.rootUser | b64enc }}
  rootPassword: {{ .Values.minio.auth.rootPassword | b64enc }}
---
# OAuth/Keycloak credentials for Onyx
# Onyx auto-provisions its own Keycloak client ('onyx-client') at startup
# using the KEYCLOAK_ADMIN_PASSWORD to authenticate to Keycloak admin API.
# DO NOT set oauth_client_id or oauth_client_secret - leave them empty
# so Onyx's built-in provisioning creates the client with directAccessGrantsEnabled.
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-onyx-oauth
  labels:
    app.kubernetes.io/component: onyx
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
data:
  # Keycloak admin password - required for Onyx to auto-provision its OAuth client
  keycloak_admin_password: {{ .Values.keycloak.auth.adminPassword | b64enc }}
  # Cookie secret for session encryption (separate from OAuth client credentials)
  oauth_cookie_secret: {{ randAlphaNum 64 | b64enc }}
{{- end }}
