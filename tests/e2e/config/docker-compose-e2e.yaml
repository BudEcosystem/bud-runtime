version: "3.8"

services:
  # ==========================================================================
  # Infrastructure Services
  # ==========================================================================

  e2e-postgres:
    image: postgres:15-alpine
    container_name: e2e-postgres
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: budapp_e2e
    ports:
      - "5433:5432"
    volumes:
      - e2e-postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d budapp_e2e"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network

  e2e-redis:
    image: redis:7-alpine
    container_name: e2e-redis
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network

  e2e-keycloak:
    image: quay.io/keycloak/keycloak:26.1.4
    container_name: e2e-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://e2e-postgres:5432/keycloak_e2e
      KC_DB_USERNAME: testuser
      KC_DB_PASSWORD: testpass
      KC_HEALTH_ENABLED: "true"
    ports:
      - "8080:8080"
    command: start-dev
    depends_on:
      e2e-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - e2e-network

  # ==========================================================================
  # Dapr Infrastructure
  # ==========================================================================

  e2e-placement:
    image: daprio/placement:1.14.4
    container_name: e2e-placement
    command: ["./placement", "--port", "50006"]
    ports:
      - "50006:50006"
    networks:
      - e2e-network

  e2e-scheduler:
    image: daprio/dapr:1.14.4
    container_name: e2e-scheduler
    command: ["./scheduler", "--port", "50007", "--log-as-json"]
    ports:
      - "50007:50007"
    volumes:
      - type: tmpfs
        target: /data
        tmpfs:
          size: 1GB
    privileged: true
    networks:
      - e2e-network

  # ==========================================================================
  # Application Services
  # ==========================================================================

  e2e-budapp:
    image: bud-serve/budapp:e2e
    container_name: e2e-budapp
    build:
      context: ../../../services/budapp
      dockerfile: ./deploy/Dockerfile
    command: >
      sh -c "
        alembic -c ./budapp/alembic.ini upgrade head &&
        uvicorn budapp.main:app --host 0.0.0.0 --port 9081
      "
    ports:
      - "8001:9081"
      - "3510:3510"
    environment:
      APP_NAME: budapp
      NAMESPACE: e2e
      LOG_LEVEL: DEBUG
      APP_PORT: "9081"
      # Disable rate limiting for E2E tests
      RATE_LIMIT_ENABLED: "false"
      DAPR_HTTP_PORT: "3510"
      DAPR_GRPC_PORT: "50001"
      DAPR_PLACEMENT_HOST: e2e-placement
      DAPR_PLACEMENT_PORT: "50006"
      DAPR_SCHEDULER_HOST: e2e-scheduler
      DAPR_SCHEDULER_PORT: "50007"
      DAPR_API_TOKEN: ""
      CONFIGSTORE_NAME: configstore
      SECRETSTORE_NAME: secretstore-local
      # PostgreSQL
      PSQL_HOST: e2e-postgres
      PSQL_PORT: "5432"
      PSQL_USER: testuser
      PSQL_PASSWORD: testpass
      PSQL_DB_NAME: budapp_e2e
      # Redis
      SECRETS_REDIS_URI: e2e-redis:6379
      SECRETS_REDIS_PASSWORD: ""
      # Keycloak
      KEYCLOAK_SERVER_URL: http://e2e-keycloak:8080/
      KEYCLOAK_REALM_NAME: master
      KEYCLOAK_ADMIN_USERNAME: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_VERIFY_SSL: "false"
      DEFAULT_REALM_NAME: e2e-realm
      DEFAULT_CLIENT_NAME: e2e-client
      # JWT
      JWT_SECRET_KEY: e2e-test-secret-key-for-jwt-signing-minimum-32-chars
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      REFRESH_TOKEN_EXPIRE_MINUTES: "10080"
      PASSWORD_SALT: e2e_password_salt
      # CORS
      CORS_ORIGINS: "*"
      # Frontend
      FRONTEND_URL: http://localhost:3000
      ADMIN_FRONTEND_URL: http://localhost:8007
      # Service Discovery
      BUD_CLUSTER_APP_ID: budcluster
      BUD_MODEL_APP_ID: budmodel
      BUD_METRICS_APP_ID: budmetrics
      BUD_NOTIFY_APP_ID: notify
      BUD_SIMULATOR_APP_ID: budsim
    volumes:
      - ../../../services/budapp:/app
      - ./dapr/components:/components
      - ./dapr/appconfig.yaml:/config/appconfig.yaml
    depends_on:
      e2e-postgres:
        condition: service_healthy
      e2e-redis:
        condition: service_healthy
      e2e-keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9081/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - e2e-network

  e2e-budapp-sidecar:
    image: daprio/daprd:1.14.4
    container_name: e2e-budapp-dapr
    command:
      - "./daprd"
      - "--app-id"
      - "budapp"
      - "--app-port"
      - "9081"
      - "--dapr-http-port"
      - "3510"
      - "--dapr-grpc-port"
      - "50001"
      - "--placement-host-address"
      - "e2e-placement:50006"
      - "--scheduler-host-address"
      - "e2e-scheduler:50007"
      - "--resources-path"
      - "/components"
      - "--config"
      - "/config/appconfig.yaml"
      - "--log-as-json"
    volumes:
      - ./dapr/components:/components
      - ./dapr/appconfig.yaml:/config/appconfig.yaml
    depends_on:
      - e2e-budapp
    network_mode: "service:e2e-budapp"

networks:
  e2e-network:
    name: e2e-network
    driver: bridge

volumes:
  e2e-postgres-data:
